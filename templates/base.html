<head>
    <title>RIJF ScheduleMaker</title>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var shrink = document.querySelector('input[name="shrunk"]');

            if (shrink && shrink.value === "True") {
                shrinkTable();
            }
        });

        function scrollToTable() {
            var scheduleSection = document.getElementById('schedule');
            if (scheduleSection) {
                scheduleSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function submitForm(name){
            let last = document.getElementById("last-selected");
            last.value = name;
            document.getElementById("artist-picker").submit();
        }

        function deselect(){
            var fldSet = document.getElementById("cboxfield");
            var chkBoxes = fldSet.getElementsByTagName('input'); 
            for(var i=0;i<chkBoxes.length;i++){ 
                if(chkBoxes[i].type == 'checkbox'){
                    chkBoxes[i].checked = false;
                }
            }
        }

        function hideshow(){
            var cbox = document.getElementById("cboxfield");
            cbox.hidden = !cbox.hidden;

            var button = document.getElementById("hider");
            if (button.value == "Hide Artists"){
                button.value = "Show Artists";
            }else{
                button.value = "Hide Artists";
            }
        }

        /* Credit Calumah from StackOverflow */
        function download_table_as_csv(table_id, separator = ',') {
            // Select rows from table_id
            var rows = document.querySelectorAll('table#' + table_id + ' tr');
            // Construct csv
            var csv = [];
            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll('td, th');
                for (var j = 0; j < cols.length; j++) {
                    // Clean innertext to remove multiple spaces and jumpline (break csv)
                    var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ')
                    // Escape double-quote with double-double-quote (see https://stackoverflow.com/questions/17808511/properly-escape-a-double-quote-in-csv)
                    data = data.replace(/"/g, '""');
                    // Push escaped string
                    row.push('"' + data + '"');
                }
                csv.push(row.join(separator));
            }
            var csv_string = csv.join('\n');
            // Download it
            var filename = 'RIJF2024.csv';
            var link = document.createElement('a');
            link.style.display = 'none';
            link.setAttribute('target', '_blank');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv_string));
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /* Generated by Copilot */
        function shrinkTable(){
            var button = document.getElementById("shrinker");
            var shrunk = document.querySelector('input[name="shrunk"]');

            if (button.value === "Shrink Table") {
                
                var table = document.getElementById("schedule");
                if (!table) return;
                var rows = table.getElementsByTagName("tr");
                for (var i = 1; i < rows.length; i++) { // skip header row
                    var tds = rows[i].getElementsByTagName("td");
                    var allEmpty = true;
                    for (var j = 0; j < tds.length; j++) {
                        if (tds[j].textContent.trim() !== "") {
                            allEmpty = false;
                            break;
                        }
                    }
                    if (tds.length > 0 && allEmpty) {
                        rows[i].classList.add("hidden-row");
                    } else {
                        rows[i].classList.remove("hidden-row");
                    }
                }
                button.value = "Expand Table";
                shrunk.value = "True";
            } else {
                var table = document.getElementById("schedule");
                if (!table) return;
                var rows = table.getElementsByTagName("tr");
                for (var i = 1; i < rows.length; i++) { // skip header row
                    rows[i].classList.remove("hidden-row");
                }
                button.value = "Shrink Table";
                shrunk.value = "False";
            }
        }
    </script>

</head>
<header>
    <div>
        <h1>
            <span class="color1">RIJF</span>
            <span class="color2">2025</span>
            <span class="color3">SCHEDULE</span>
            <span class="color4">CREATOR</span>
        </h1>
        <p class="subtitle">Created by Harbor Wolff</p>
    </div>
    <div>Automatically create RIJF 2025 schedules of all the artists you want to see!</div>
    <div class="caveat">It may take a few seconds to load larger schedules. Schedule does not include 12:00 shows at the library.</div>
    <div><a href="https://www.rochesterjazz.com/" target="_blank">Main festival website</a></div>
</header>
<main>
    <div style="margin-top: 4px; background: linear-gradient(90deg, #f7f7f7 0%, #e3e3e3 100%); border: 2px solid #e74c3c; border-radius: 7px; box-shadow: 0 1px 4px rgba(44,62,80,0.08); padding: 8px 10px 4px 10px; margin-bottom: 10px;">
        <form id="artist-picker" action="{{url_for('base')}}" method="post">
            <input type="hidden" id="last-selected" name="last-selected" value="TEST">
            <div title="Adjust how many shows can overlap at the same time slot;">
                <label for="max-overlap" style="width: 129px; display: inline-block;"><strong>Max. Overlap</strong></label>
                <input id="max-overlap" class="max-overlap" type="number" name="max-overlap" value="{{max_overlap}}" min="1" max="10" onchange="document.getElementById('artist-picker').submit();">
            </div>
            <fieldset id="cboxfield" class="selector">
                <legend><strong>Select Artists to Add to Schedule</strong></legend>
                {% for ast in artists %}
                    {% if ast['name'] | length < 20 %}
                    <span onclick="submitForm('{{ast['name']}}')">
                        <input type="checkbox" id="{{ast['name']}}" name="{{ast['name']}}" value="{{ast['name']}}" {% if ast['name'] in selected %}checked{% endif %}>
                        <label for="{{ast['name']}}" title="{{ast['name']}}">{{ast['name']}}</label>
                    </span>
                    {% else %}
                    <span onclick="submitForm('{{ast['name']}}')">
                        <input type="checkbox" id="{{ast['name']}}" name="{{ast['name']}}" value="{{ast['name']}}" {% if ast['name'] in selected %}checked{% endif %}>
                        <label for="{{ast['name']}}" title="{{ast['name']}}">{{ast['name'][:20]}}...</label>
                    </span>
                    {% endif %}
                {% endfor %}
            </fieldset>
            <br>
            <input class="control-buttons" type="button" value="Uncheck All" onclick="deselect()" title="Uncheck All Artists">
            <input id="hider" class="control-buttons" type="button" value="Hide Artists" onclick="hideshow()" title="Hide Artist List">
            <input id="shrinker" class="control-buttons" type="button" value="Shrink Table" onclick="shrinkTable()" title="Compress the schedule table to only show active time slots">
            <input class="export" type="button" value="Export CSV" onclick="download_table_as_csv('schedule')" title="Export the schedule as a CSV file">
            <input type="hidden" name="shrunk" value="{{shrink}}">
        </form>
    </div>
    {% if festival is not none %}
        {% if festival %}
            <section style="background: #fff; border-radius: 14px; box-shadow: 0 4px 24px rgba(44,62,80,0.10); padding: 32px 18px 24px 18px; margin-bottom: 36px; border: 1.5px solid #b2bec3;">
                <div>
                    <table id="schedule">
                        <thead>
                            <tr>
                            <th></th>
                            <th>6-20</th>
                            <th>6-21</th>
                            <th>6-22</th>
                            <th>6-23</th>
                            <th>6-24</th>
                            <th>6-25</th>
                            <th>6-26</th>
                            <th>6-27</th>
                            <th>6-28</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for i in range(0,11) %}
                        <tr>
                            <th>{{i+1}}:00 PM</th>
                            {% for day in festival %}
                                {% if day[4*i+0] | length > 0 %}
                                    <td><div class="cell">
                                    {% for show in range(0, day[4*i+0] | length) %}
                                        <div title="{{day[4*i+0][show]|safe}}" style="background-color: {{day[4*i+0][show] | color }}; width: {{100 - (day[4*i+0] | length)}}%;">{{day[4*i+0][show]|safe}}</div>
                                    {% endfor %}
                                    </div></td>
                                {% else %}
                                    <td></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>{{i+1}}:15 PM</th>
                            {% for day in festival %}
                                {% if day[4*i+1] | length > 0 %}
                                    <td><div class="cell">
                                    {% for show in range(0, day[4*i+1] | length) %}
                                        <div title="{{day[4*i+1][show]|safe}}" style="background-color: {{day[4*i+1][show] | color }}; width: {{100 - (day[4*i+1] | length)}}%;">{{day[4*i+1][show]|safe}}</div>
                                    {% endfor %}
                                    </div></td>
                                {% else %}
                                    <td></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>{{i+1}}:30 PM</th>
                            {% for day in festival %}
                                {% if day[4*i+2] | length > 0 %}
                                    <td><div class="cell">
                                    {% for show in range(0, day[4*i+2] | length) %}
                                        <div title="{{day[4*i+2][show]|safe}}" style="background-color: {{day[4*i+2][show] | color }}; width: {{100 - (day[4*i+2] | length)}}%;">{{day[4*i+2][show]|safe}}</div>
                                    {% endfor %}
                                    </div></td>
                                {% else %}
                                    <td></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>{{i+1}}:45 PM</th>
                            {% for day in festival %}
                                {% if day[4*i+3] | length > 0 %}
                                    <td><div class="cell">
                                    {% for show in range(0, day[4*i+3] | length) %}
                                        <div title="{{day[4*i+3][show]|safe}}" style="background-color: {{day[4*i+3][show] | color }}; width: {{100 - (day[4*i+3] | length)}}%;">{{day[4*i+3][show]|safe}}</div>
                                    {% endfor %}
                                    </div></td>
                                {% else %}
                                    <td></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        {% else %}
            <section style="background: #fffbe6; border-radius: 12px; box-shadow: 0 2px 12px rgba(231, 76, 60, 0.08); padding: 24px 18px; margin-bottom: 36px; border: 1.5px solid #f7ca18;">
                <div class="warning" style="font-size: 1.3rem; color: #e74c3c;">
                    Select Artists above to create a Schedule!
                </div>
            </section>
        {% endif %}
    {% else %}
        {% if conflicts|length != 0%}
            <section style="background: #fffbe6; border-radius: 12px; box-shadow: 0 2px 12px rgba(231, 76, 60, 0.08); padding: 24px 18px; margin-bottom: 36px; border: 1.5px solid #f7ca18;">
                <div class="warning" style="font-size: 1.2rem;">
                    This Schedule is not possible: <span style="color:#e74c3c;">{{failed}}</span> conflicts with <span style="color:#e74c3c;">{{', '.join(conflicts)}}</span>.<br>
                    <span style="color:#2c3e50;">Try removing different artists or allowing for more overlap!</span>
                </div>
            </section>
        {% else %}
            <section style="background: #fffbe6; border-radius: 12px; box-shadow: 0 2px 12px rgba(231, 76, 60, 0.08); padding: 24px 18px; margin-bottom: 36px; border: 1.5px solid #f7ca18;">
                <div class="warning" style="font-size: 1.2rem;">
                    This Schedule is not possible.<br>
                    <span style="color:#2c3e50;">Try removing a few artists or allowing for more overlap!</span>
                </div>
            </section>
        {% endif %}
    {% endif %}
</main>
<button id="toTopBtn" title="Back to Top">↑</button>
<script>
// Show/hide the button on scroll
window.addEventListener('scroll', function() {
    var btn = document.getElementById('toTopBtn');
    if (!btn) return;
    if (window.scrollY > 200) {
        btn.style.display = 'block';
    } else {
        btn.style.display = 'none';
    }
});
// Scroll to top on click
var btn = document.getElementById('toTopBtn');
if (btn) {
    btn.onclick = function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
}
</script>
